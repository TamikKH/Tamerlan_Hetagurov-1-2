```markdown
Отчет по лабораторной работе №5
Надежность: Журнал предзаписи (WAL)

2025-10-19
4 курс 1 полугодие 
Пиж-б-о-22-1
Администрирование баз данных
Хетагуров Тамерлан Аланович

Цель работы: Изучить работу буферного кеша и механизма журналирования предзаписи (WAL) в
 PostgreSQL. Получить практические навыки управления контрольными точками, анализа журнальных
 записей, настройки параметров WAL и исследования процессов восстановления после сбоев

Теоретическая часть (краткое содержание):

Буферный кеш: Область общей памяти для кэширования страниц данных, считываемых с диска.
 Измененные ("грязные") буферы периодически сбрасываются на диск.
Контрольная точка (Checkpoint): Процесс принудительной записи всех "грязных" буферов на
 диск. Ограничивает объем WAL, необходимый для восстановления.
Журнал предзаписи (WAL): Циклический журнал, в который записываются все изменения
 данных перед тем, как они попадут в основные файлы данных. Обеспечивает надежность и
 возможность восстановления после сбоя.
Восстановление: Процесс применения WAL-записей, созданных после последней контрольной
 точки, к данным на диске для приведения их в согласованное состояние

 Модуль 1: Процессы и режимы остановки
 1. Поиск процессов: Средствами ОС (например, ps aux | grep postgres) найдите процессы,
 отвечающие за работу буферного кеша (checkpointer, background writer) и журнала WAL
 (walwriter).
 2. Остановка Fast:
 Остановите PostgreSQL в режиме fast (sudo pg_ctlcluster 16 main stop).
 Запустите сервер. Просмотрите журнал сообщений сервера
 (/var/log/postgresql/postgresql-16-main.log). Найдите записи о контрольной точке,
 выполненной при завершении работы.
 3. Остановка Immediate:
 Остановите PostgreSQL в режиме immediate (sudo pg_ctlcluster 16 main stop -m
 immediate).
 Запустите сервер. Просмотрите журнал сообщений. Найдите записи о восстановлении
 после сбоя (recovery). Сравните с предыдущим случаем.


 Модуль 2: Буферный кеш и контрольные точки
 1. Анализ размера:
 Создайте таблицу wal_test (id INT, data TEXT). Вставьте в нее достаточное количество
 строк.
 Определите, сколько страниц на диске занимает таблица (например, с помощью
 pg_relation_size(...) / current_setting('block_size')::int).
 Определите, сколько буферов занимает таблица в кеше (запрос к pg_buffercache).
 2. Грязные буферы и контрольная точка:
 Узнайте общее количество "грязных" буферов в кеше (запрос к pg_stat_bgwriter или
 pg_buffercache).
 Выполните команду CHECKPOINT;.
 Снова проверьте количество "грязных" буферов. Объясните результат.
 3. Предварительное чтение (pg_prewarm):
 Подключите расширение pg_prewarm.
 Загрузите свою таблицу в кеш с помощью pg_prewarm(...).
 Перезапустите сервер.
 Проверьте, осталась ли таблица в кеше. Проанализируйте эффективность метода.


 Модуль 3: Журнал предзаписи (WAL)
 1. Размер WAL-записей:
 Запомните текущую позицию LSN (SELECT pg_current_wal_lsn();).
 Создайте таблицу с первичным ключом, вставьте несколько строк, зафиксируйте.
 Определите объем сгенерированных WAL-записей (SELECT pg_current_wal_lsn() 
'LSN'::pg_lsn;).
 2. Анализ WAL:
 Объясните относительно большой размер записей. При необходимости используйте
 pg_waldump для просмотра заголовков записей.
 3. Восстановление после сбоя:
 Вставьте строку в таблицу и зафиксируйте.
 Начните новую транзакцию, обновите строки, НЕ фиксируйте.
 Сымитируйте сбой, принудительно завершив процесс postmaster (kill -9 или аварийная
 остановка).
 Запустите сервер. Убедитесь, что зафиксированное изменение сохранилось, а
 незафиксированное — откатилось.
 Найдите в журнале сообщений записи о процессе восстановления.


 Модуль 4: Настройка WAL
 1. Влияние full_page_writes:
 Изучите влияние параметра full_page_writes (вкл./выкл.) на объем генерируемых WAL
записей.
 Проведите простой тест: выполните контрольную точку, затем серию изменений в таблице
 (например, с помощью pgbench), измерьте объем WAL.
 Повторите тест с разным значением full_page_writes. Объясните разницу в результатах.
 2. Эффективность сжатия WAL:
 Изучите влияние параметра wal_compression (вкл./выкл.) на объем WAL.
 Проведите тест, аналогичный п.1, с включенным и выключенным сжатием.
 Определите, во сколько раз уменьшается размер WAL-записей при использовании сжатия.
